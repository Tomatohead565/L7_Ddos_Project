Oh shit here we go again...
## Что такое Ddos?
**DDoS** — это Distributed Denial of Service, **распределённый отказ в обслуживании**. По сути это хакерская атака, которая перегружает систему, чтобы конечные потребители не могли пользоваться сервисом. Атака может быть направлена на всю ИТ-инфраструктуру, конкретный сервис либо канал до этого сервиса.

Распределённая — значит, что атака выполняется **одновременно** с большого количества устройств, которые зачастую **распределены географически**. Это могут быть как специально подготовленные сервера, так и ботнеты из зараженных устройств. Ботнет — это группа устройств, на которых запущены скрипты, выполняющие нужный злоумышленнику код, в данном случае — DDoS-атаку. Зачастую ботнеты собираются из устройств, зараженных вредоносным ПО, и их владельцы даже не подозревает о «двойной жизни» своих гаджетов.
## Какие виды Ddos бывают и в чём их различие
**Низкоуровневые**. Они происходят на L3-L4 модели OSI, то есть в районе **сетевого** и **транспортного** протокола:

Сетевой уровень (**L3**): DDoS-атаки по протоколам IPv4, IPv6, ICMP, IGMP, IPsec, RIP, OSPF. Цели таких атак —  в первую очередь **сетевые устройства**.

Транспортный уровень (**L4**): воздействие по протоколам TCP и UDP. Цели таких атак — **конечные серверы и некоторые интернет-сервисы**.

Такие атаки весьма распространены. Дело в том, что стандарты интернета и делались с расчётом на то, что все участники будут добросовестно (смешной анекдот) их использовать.

Например, в протоколе **UDP**, который работает **поверх** IP, информация передаётся **датаграммами**, и в заголовках пакета **не содержится IP ни источника, ни получателя**. UDP доверяет адресацию протоколу IP, поверх которого работает, а в протоколе IP эти заголовки есть, но они никак не проверяются. Соответственно, очень многие атаки основаны на том, что меняется один из IP-адресов, как правило, это IP-адрес источника. Это называется **спуфингом**, т.е. атакой с подменой данных одного из узлов.

**Высокоуровневые** (наш случай). DDoS-атаки **L7** направлены на **приложения** и обычно выполняются на уровне протокола **HTTP/HTTPS**. Это атаки, которые **имитируют поведение реальных пользователей** и обращаются к функциям веб-приложения, таким как формы авторизации, поиск, AJAX-запросы и так далее. Цель таких атак — исчерпать ресурсы сервера или сделать его недоступным для реальных пользователей, превышая лимиты обработки запросов.

DDoS уровня L7 нацелен на приложение, тогда как атаки L3/L4 направлены на сетевую инфраструктуру и транспортный уровень. Для атаки на инфраструктуру злоумышленник генерирует **большой объем трафика**. Для атаки на уровне L7 такие объемы не обязательны. Зная особенности приложения, атакующий может генерировать меньше запросов, но направить их точечно, в «узкое горло» приложения, и гарантированно ухудшить его работу или полностью положить его. Например, можно сделать 1000 запросов к базе данных, с которой работает приложение, и тем самым добиться отказа в его работе.

## Типы L7 атак
1. **Медленные атаки малого объема**, так называемые «Low and Slow». Этот вариант представляет опасность в силу **малой заметности** и **продолжительного времени** нарастания зловредного воздействия. Обычно здесь речь идет о воздействии на приложения и иногда на серверные ресурсы;
2. **Атаки, основанные на значительном числе произвольных «мусорных» запросов**. Целью таких атак обычно является мощный «кумулятивный» удар по системе, вследствие которого она долгое время не сможет обрабатывать запросы от легитимных пользователей. Характерным примером является атака типа **Wordpress Pingback DDoS**. Хотя эта атака однозначно обнаруживается и фильтруется по типовым HTTP-заголовкам, тем не менее, она может составлять серьёзную проблему для атакуемого ресурса, поскольку полоса такой атаки может достигать **десятков Гбит/с** и в состоянии превысить показатели по доступности канальной ёмкости и производительности HTTP-сервера;
3. **Атаки, имитирующие поведение легитимного пользователя**. В отличие от предыдущей разновидности, такие атаки используют большое количество **неагрессивных** ботов, что затрудняет анализ в режиме реального времени. Зачастую эти механизмы используют «узкие места» или уязвимости в web-приложениях и остальной инфраструктуре. Это может привести к **несанкционированному доступу** к системе, **потерям** и **несанкционированным изменениям данных**. Для обнаружения «узких мест» атакующий может использовать сканирование сети – действие, которое, на первый взгляд, представляется безвредным, поскольку само по себе не приносит урона, но на самом деле позволяет получить информацию, которая поможет в дальнейшем атаковать систему.

## Длиннотекст про известные L7 атаки

В атаке могут использоваться любые HTTP-запросы, но обычно используют **GET** и **POST**. Атака также может осуществляться с использованием шифрованных TLS-сессий. Конечной целью атаки является **исчерпание ресурсов web‑приложения**. Тут надо понимать, что "железных" ресурсов сервера еще может оставаться много - и незабитого канала тоже может (но не обязательно) остаться много. Но узким местом станет именно **само веб-приложение**: из-за особенностей конфигурации или в силу других причин оно либо просто перестанет обслуживать легальные запросы, либо просто упадет.

Атака осуществляется следующим образом: отправляется **небольшой по объему HTTP-запрос**, в ответ на который сервер должен прислать **куда больший** объем информации. Несомненно, канал сервера во много раз «шире» канала, который использует атакующий, но ведь и отдавать информации приходится намного больше; кроме того, не составит труда подменить IP-адрес источника.

Следовательно, ответные пакеты сервера **не вызовут** эффекта отказа в обслуживании атакующего узла, более того, таких узлов может быть огромное количество.

**Угрозы** от этой атаки - **исчерпание канальной емкости** и **отказ на уровне обработки запросов**, так как у любого HTTP-сервера, а тем более – web-приложения или ресурсов, обеспечивающих его работу (система авторизации, СУБД и др.), есть свой **предел производительности**. В результате, легальный запрос **не будет** обработан, а пользователь не получит своей порции цифрового контента.

## HTTP-атаки с использованием шифрования (HTTPS Flood)

В настоящее время практически все разработчики используют в своих приложениях SSL/TLS для шифрования трафика и обеспечения сквозной безопасности при передаче данных. Любая DDoS-атака на приложение, допускающее шифрование, может быть запущена поверх трафика, зашифрованного SSL/TLS, что создает определенные трудности в ее идентификации. Большинство технологий противодействия DoS атакам не производят реальной проверки трафика SSL, так как это требует расшифровки зашифрованных данных.

## Wordpress Pingback DDoS

Определенная популярность есть у Reflection DDoS-атак уровня L7 (приложений). Наиболее характерным примером такой атаки является Wordpress Pingback DDoS, которую и рассмотрим.

Основной её принцип заключается в следующем. Чрезвычайно распространённый web-фреймворк Wordpress до определенных версий предоставлял публичное API, позволяющее запросить любую web-страницу с любого удалённого HTTP-сервера без авторизации. Таким образом, отправив небольшой (до 400 байт) запрос на уязвимый Wordpress-сервер, можно было инициировать загрузку любой крупной страницы (или файла, если это возможно без авторизации) с атакуемого сервера на уязвимый сервер.

В ходе такой атаки определённая нагрузка ложится и на уязвимый Wordpress-сервер, однако, в силу того, что в нападении участвует несколько тысяч Wordpress-серверов и атака разделяется между ними примерно равномерно, нагрузка на каждый отдельный сервер обычно не является критичной и может быть даже не замечена системным администратором на фоне ежедневной средней загрузки. Основная же доля нагрузки приходится именно на атакуемый ресурс.

Интересно, что эта атака, несмотря на то, что Wordpress давно исправил уязвимость была популярна и в 2021, и 2022 г, поскольку в Интернете находилось порядка нескольких миллионов Wordpress-серверов, пригодных для эксплуатации в атаке типа Wordpress Pingback DDoS, и, как минимум, в ряде инцидентов принимало участие одновременно до 350 тыс. уязвимых серверов. Так как в большинстве случаев фреймворк Wordpress развёрнут не на рабочей станции (как обычный модуль бот-сети), а на сервере с неплохой производительностью и канальной ёмкостью, то атаки типа Pingback DDoS на канальном уровне достигали уровня в 10 Гбит/с и более.

В тоже время, атака типа Wordpress Pingback DDoS, организуемая на HTTP-ресурс без шифрования, достаточно легко идентифицируется и несложно фильтруется при наличии достаточной производительности и канальной ёмкости (от 20 Гбит/с).

Важной особенностью Pingback-атаки является то, что уязвимый сервер в состоянии запрашивать произвольные крупные web-страницы как по HTTP, так и по HTTPS, то есть внутри зашифрованной SSL/TLS-сессии. Это приводит к невозможности фильтрации такой Reflection-атаки при отсутствии адекватных механизмов анализа зашифрованного трафика. Для борьбы с Pingback DDoS в общем случае требуется раскрытие текстовой информации, содержащейся внутри TLS-сессий.

В целом, не надо думать, что Pingback-атаки характерны только для Wordpress. Они могут вылезти на любом приложении, которое позволяет перенаправить запрос (в силу своей архитектурной особенности или ошибок конфигурации). Поэтому, очень важно, при настройке веб-приложений максимально минимизировать возможности запросов для неавторизованных пользователей - особенно это касается той части, которая отвечает за обработку API.

## Full Browser Stack-атаки и имитация поведения пользователя

Одной из самых сложной для идентификации и фильтрации разновидностью атаки уровня приложения являются, так называемые, FBS‑атаки (от англ. «Full Browser Stack» – полноценная среда браузера). В этом случае для генерации паразитных запросов используются не обычные легковесные библиотеки, имитирующие браузер, а полноценный экземпляр браузера, способный корректно формировать запросы (либо качественный эмулятор), загружать с атакуемого web-сервера изображения и CSS-стили, выполнять HTTP-переадресацию и JavaScript-код. Такую атаку очень сложно отследить и классифицировать, анализируя каждый пакет или каждый запрос в отдельности, поскольку каждый отдельный запрос полностью легитимен и идентичен пользовательскому.

Для борьбы с такими атаками недостаточно тривиальных проверок наподобие HTTP-редиректов и JavaScript-проверок. Используются, как правило, нестрогие статистические алгоритмы, анализ истории поведения пользователей, поиск закономерностей и мониторинг состояния защищаемого сервера. Подобный анализ, как правило, чрезвычайно вычислительно сложен и подразумевает хранение больших объёмов данных с возможностью быстрого поиска по ним. Таким образом, решение по фильтрации атак уровня приложения (L7-атак) должно быть в состоянии работать с большими объёмами данных в реальном времени.

Следует отметить, что подобные атаки необязательно будут организованы именно посредством бот-сети. В ряде случаев они проводятся хактивистами, т.е. живыми людьми. В этом случае распространённое решение с демонстрацией изображений или решения головоломок типа CAPTCHA также может быть неэффективным, хотя, безусловно, создающее дополнительные трудности атакующему.

## Медленные атаки малого объема (Slow and Low)

DDoS атаки не всегда подразумевают большой объем трафика и бот-сети из сотен узлов. Иногда вполне достаточно даже одного компьютера, чтобы остановить работу сервиса. Существует целый класс атак, направленных на приложения, то есть работающих на L7 (прикладном) уровне модели ISO/OSI, использующих минимум ресурсов. Зачастую бывает вполне достаточно и одного компьютера, используются стандартные принципы работы прикладных протоколов. Но их негативное воздействие оказывается весьма значительным, вплоть до полной остановки работы сервисов.

Речь идет о медленных атаках небольшого объема («Slow and Low»). Ниже приведены некоторые представители подобного рода атак.

## Are You Dead Yet / RUDY

Принцип этой атаки базируется на стандартном поведении протокола HTTP при обработке запросов POST.

Предположим, имеется web-сайт, на котором находится форма для ввода данных, которую необходимо заполнить пользователю. Например, это характерно для финансовых учреждений, банков, интернет-магазинов, систем бронирования билетов, любого сайта, на котором требуется аутентификация и т.д.

Когда легитимный пользователь заполняет web-форму, на сайт отправляется всего несколько пакетов, после чего сессия с web-сервером закрывается, ресурсы освобождаются. Сервер готов обслуживать запросы других пользователей. Атакующий, использующий специальный инструмент, например, RUDY (сам инструмент достаточно древний и стал именем нарицательным для подобных инструментов, которые разрабатываются и в 2022), действует иначе. Отправляемые на web-сервер данные разбиваются на множество мелких пакетов, каждый из которых содержит лишь небольшой объем данных, например, один байт. Запросы на сервер отправляются со случайным интервалом, что не дает возможность серверу сразу закрыть сессию, поскольку передача данных еще не завершена.

Несколько тысяч таких запросов в течение нескольких минут приводят к тому, что сервер не может отвечать на запросы легитимных пользователей.

Но в данном случае не требуется большой объем трафика или значительное количество пакетов, чтобы вывести ресурс из строя. Все запросы абсолютно легитимны, здесь имитируется поведение системы с медленным каналом связи. Цель атакующего достигнута – работать с сайтом невозможно. Подобная уязвимость характерна практически для любого сайта. Поэтому для отсечки таких атак целесообразно использовать очистку трафика.

## SlowLoris

Атака SlowLoris, также как и предыдущая, базируется на стандартном поведении протокола HTTP при обработке запросов. Для закрытия HTTP сессии необходимо прислать соответствующую последовательность.

Собственно говоря, так и поступает легитимный пользователь. Правильный запрос на получение данных с web-сервера (Get Request) обычно состоит из одного пакета и завершается специальной последовательностью в конце для разрыва сессии.

 Суть атаки заключается в следующем: используя специальный инструмент SlowLoris или подобные, атакующий генерирует множественные подключения к целевому web-серверу, при этом соединения не закрываются, поскольку в запросе будет отсутствовать соответствующая последовательность символов. В результате, ресурсы сервера будут исчерпаны и легитимные пользователи не смогут подключиться. Цель атакующего достигнута – работать с сайтом невозможно. Большой объем трафика или значительное количество пакетов не требуется, чтобы вывести ресурс из строя.

В целом, не сказать, что атака является достаточно серьезной проблемой, если вы озаботились защитой от DDoS-атак. Но для слабо защищенных веб-серверов она может стать проблемой, несмотря на хорошую детектируемость.

## DNS flood

Другим характерным примером атаки на приложения, не связанным напрямую с протоколом HTTP, является DNS flood. Организация его не составляет большого труда, что, собственно, и послужило залогом его большого распространения.

Как известно, серверы DNS служат для разрешения имен в IP-адреса. Основная задача DNS сервера – найти требуемый адрес, чтобы компьютер смог обратиться на искомый сайт. Атака построена на принципах взаимодействия клиента и сервера DNS. Атакующий, используя бот-сеть, посылает множество запросов на сервер жертвы. Сервер перегружен и не сможет разрешать имена по запросам легитимных пользователей, и следовательно, они не смогут обратиться на требуемый им ресурс, поскольку не смогли разрешить его имя в адрес (при этом, в подавляющем большинстве случаев можно обратиться на сервер по его IP-адресу).

Усиление атаки достигается за счет того, что DNS использует в качестве транспортного протокол UDP, который не требует установки соединения, то есть без использования «троекратного рукопожатия» (three-way handshake), не аутентифицирует удалённую сторону и работает без сохранения состояния соединения.  Это дает возможность атакующему свободно подменять IP-адрес отправителя в запросе к DNS-серверу на поддельный адрес, а также направлять ответы других DNS-серверов в адрес его жертвы (DNS Reflection).

## Методы борьбы

**CPE-решения (решение, устанавливаемое у защищаемой организации)**

Традиционным методом защиты от DDoS‑атак является установка в защищаемую сеть специализированного CPE‑решения (Customer Premises Equipment – оборудование, устанавливаемое у клиента), основной или единственной функцией которого является фильтрация паразитного трафика, угрожающего работоспособности сети или её отдельных компонентов.

К основным плюсам такого решения относятся:

**Полноценный контроль за пользовательским трафиком, возможность тонкой настройки силами подразделения информационных \ сетевых технологий или службы эксплуатации**

**Заведомое отсутствие необходимости раскрывать чувствительные данные (например, ключи шифрования или содержимое шифрованных сессий) третьей стороне**

Минусы CPE-решений:

**Необходимость в квалифицированной штатной службе эксплуатации, знакомой со всеми аспектами специфики DDoS-атак, периодически проходящей соответствующее обучение и доступной в режиме 24/7/365 (если решение не автоматическое; но в случае автоматического решения все равно возникает потребность в квалифицированных штатных специалистах, прошедших обучение по данному решению, хотя стоимость такого специалиста будет заведомо меньше стоимости содержания квалифицированной штатной службы)**

**Потребность в высокой пропускной способности подключения к Интернету. CPE-решение не сможет отфильтровать атаку в случае, если канал между CPE-решением и вышестоящим оператором связи будет перегружен паразитным трафиком. В текущих условиях требуется подключение к вышестоящему оператору с запасом пропускной способности не менее 100 Гбит/с**

**Возможные сложности с горизонтальным масштабированием решения**

**Критически важно своевременно обновлять сигнатуры и программное обеспечение CPE-решений, поддерживать их в актуальном состоянии.**

**Облачная услуга защита от DDoS**

В свете легкости создания массированных DDoS-атак, встаёт вопрос защиты канала связи. Решить эту задачу помогают облачные службы защиты от DDoS-атак, предлагающие технологии защиты в облаке – удалённой, и, как правило, топологически распределённой сети. Сейчас, пожалуй, наиболее распространенный и доступный способ защиты от DDoS-атак для большинства организаций

Основные плюсы такого решения:

**Быстрое внедрение**

**Оперативная адаптация к быстро меняющимся типам и параметрам атак**

**Обученный персонал у поставщика услуг, при этом не требуется наличия обученного персонала у заказчика**

**Стоимость решения в пересчёте на полосу атаки, как правило, ниже, чем у CPE-решения аналогичной мощности**

**Поставщик услуг может помочь "поддержать на плаву" ресурс в случае неожиданно возросшего легитимного клиентского трафика (например, это может быть характерно для ритейла перед распродажами)**

Основные минусы облачного решения:

**Необходимость постоянно или под атакой перенаправлять трафик через облако. Облачные сервисы могут использовать как схему с постоянным прохождением трафика клиента через облако, так и вариант с переключением трафика только под атакой. В последнем случае могут возникать различные негативные последствия по накопленной статистике трафика, скорости реагирования на инциденты (по сравнению с постоянным подключением), фильтруемым атакам, точности фильтрации, рискам по отслеживанию клиентской базы и т.д.**

**Зависимость от сетевой архитектуры облачного решения: компания, предоставляющая облачное решение, должна обеспечивать соответствие её сети текущему уровню угроз в любой момент времени**

**В зависимости от архитектуры сети и политик маршрутизации, прохождение трафика через внешнюю сеть защиты может увеличивать сетевые задержки, в ряде случаев – значительно**

**В случае, если облачное решение использует активные методы противодействия DDoS-атакам прикладного (L7) уровня (HTTP-редиректы, Cookies, JavaScript-тесты, CAPTCHA) – может потребоваться передача в облако закрытых ключей шифрования**

**Часть облачных сервисов предлагает не только анти-DDoS услуги, но и услуги облачного WAF для отражения атак на уязвимости web-приложений. При рассмотрении такого комбинированного решения следует учитывать, что для отражения таких атак значительный объём полосы пропускания обычно уже не требуется. Но тут надо также учитывать реалии перепродажи услуг: в этом случае реальная поддержка решения внезапно может оказаться не у того, у кого вы купили, а у какой-то третьей компании. А ваш "провайдер" будет, по сути, гонять туда-сюда вопросы - ответы. Кроме того, при такой схеме может запросто оказаться так, что WAF администрировать (и писать правила) вы будете сами. Если знания есть, а вопрос был исключительно в затратах на WAF (и его поддержку) - что ж, такой путь может оказаться неплохим вариантом. А иначе - уточняйте "на берегу", как обстоит дело с поддержкой.**

**Услуга защиты от DDoS-атак у провайдера связи**

По сути, это частный случай облачного решения, о котором было сказано выше. Многие провайдеры связи (особенно крупные) дополнительно предлагают услугу защиты от DDoS‑атак на базе своего оборудования. С определенной точки зрения, эта услуга напоминает облачное решение по защите от DDoS-атак, но с отсутствием необходимости отдельного перенаправления трафика, поскольку он и так проходит через оборудование провайдера, т.е. у вас все получается абсолютно прозрачно (и не надо заворачивать самостоятельно трафик в облако).

Несмотря на очевидные преимущества такого подхода, существует ряд недостатков, наиболее критичный из которых – отсутствие (в большинстве случаев) гарантий, что провайдер связи сам справится с DDoS-атакой. Потому что если он не справится - это может привести к недоступности защищаемого сервиса.

Кроме того, в случае, если провайдер связи не справляется с нагрузкой – он может перейти в режим «bypass», т.е. начать пропускать «грязный» трафик (целиком или частично) в сторону защищаемого сервиса, объема которого может хватить для успешной DDoS-атаки, либо он может просто "выключить" атакуемый ресурс из сети (это характерно для хостинг-провайдеров, которые вместе с хостингом предоставляют и услугу защиты от DDoS).

Поэтому, нежелательно выбирать услугу «защита от DDoS-атак», предоставляемую провайдером связи, как единственную меру защиты от DDoS-атак, но крайне желательно использовать ее в совокупности с CPE, облачным или гибридным решением (при условии, что провайдер, если не справится с DDoS-атакой, пропустит часть паразитного трафика дальше - т.е. на вас).

Кроме этого, как защиту от DDoS-атак в некоторых случаях рассматривают размещение ресурса в сетях CDN (Content Delivery Network), но стоит отметить, что такое решение не всегда целесообразно и реализуемое для ряда организаций. Кроме того, такое размещение может спасти от flood-атак, но от Low & Slow атак - не факт.

## Окей, а нам чё делать?

1. Найти датасеты с нормальным и аномальным трафиком
2. Обработка данных и выявление признаков определения запросов злоумышленника (IP адреса, cookie, количество запросов в n времени и т.п.)
3. Выбор системы машинного обучения (интегрированные системы обнаружения вторжения IDS (алгоритмы кластеризации и классификации), сетевые поведенческие анализы NBA(обучение без учителя, например кластеризация), свёрточные нейронные сети CNN и рекурентные нейронные сети RNN, анализ логов и прогнозирование (обучение с учителем, например деревья решений или случайный лес)) 
4. Оптимизация. См строчку 1 этого файла
5. Наблюдаем за процессом и правим неточности/ошибки
Готово, можно и задудосить РКН (шутка, я наверное так не буду делать, если мне вернут дискорд)